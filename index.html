<!DOCTYPE html>
<html lang="en">
<style>
@media (max-width: 600px) {
    /* Hide the Remark column on mobile screens */
    th:nth-child(5), 
    td:nth-child(5) {
        display: none;
    }
}
</style>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bus ETA</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>
    <h1>Bus ETA Information</h1>
    <table id="busTable">
        <thead>
            <tr>
                <th>巴士</th>
                <th>往</th>
                <th>巴士站</th>
                <th>預計到達時間</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            <!-- Data will be inserted here -->
        </tbody>
    </table>

    <script>
		const busStopIds = window.location.hash.substring(1);
		
        async function fetchBusStopName(busStopId) {
            const response = await fetch(`https://data.etabus.gov.hk/v1/transport/kmb/stop/${busStopId}`);
            const data = await response.json();
            return data.data.name_tc;
        }

        async function fetchBusData() {
            let now = new Date();
            let tableBody = document.querySelector('#busTable tbody');
            tableBody.innerHTML = '';

            let uniqueData = [];
            let busStopNames = {};

            let promises = busStopIds.split(',').map(busStopId => 
                fetch(`https://data.etabus.gov.hk/v1/transport/kmb/stop-eta/${busStopId}`)
                    .then(response => response.json())
                    .then(data => {
                        data.data.forEach(entry => {
                            if (!uniqueData.some(e => e.route === entry.route && e.dest_tc === entry.dest_tc && e.eta === entry.eta)) {
                                uniqueData.push({ ...entry, busStopId });
                            }
                        });
                    })
            );

            await Promise.all(promises);

            for (const busStopId of busStopIds.split(',')) {
                busStopNames[busStopId] = await fetchBusStopName(busStopId);
            }

            uniqueData.sort((a, b) => {
                if (a.eta && b.eta) {
                    return new Date(a.eta) - new Date(b.eta);
                } else if (a.eta) {
                    return -1;
                } else {
                    return 1;
                }
            });

			let groupedData = uniqueData.reduce((acc, item) => {
				// Create a unique key for each group
				let key = `${item.route}-${item.busStopId}-${item.eta_seq}`;

				// Initialize group if it doesn't exist
				if (!acc[key]) {
					acc[key] = { ... item };
				} else {
					acc[key].dest_tc = acc[key].dest_tc + " / " + item.dest_tc
				}
			  
			  // Aggregate the values
			  acc[key].totalValue += item.value;
			  
			  return acc;
			}, {});
			
			uniqueData = Object.values(groupedData);

            uniqueData.forEach(entry => {
                let etaDisplay = '-';
                if (entry.eta) {
                    const etaTime = new Date(entry.eta);
                    const etaMinutes = Math.round((etaTime - now) / 60000);
                    etaDisplay = etaMinutes < 1 ? 'arriving' : `${etaTime.getHours()}:${etaTime.getMinutes().toString().padStart(2, '0')} (${etaMinutes} min)`;
                }
                const row = `
                    <tr>
                        <td>${entry.route}</td>
                        <td>${entry.dest_tc}</td>
                        <td>${busStopNames[entry.busStopId]}</td>
                        <td>${etaDisplay}</td>
                        <td>${entry.rmk_tc}</td>
                    </tr>
                `;
                tableBody.insertAdjacentHTML('beforeend', row);
            });
        }

        fetchBusData();
        setInterval(fetchBusData, 10000);
    </script>
</body>
</html>
